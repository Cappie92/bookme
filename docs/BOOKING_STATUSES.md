# Система статусов бронирований

## Обзор

Система статусов бронирований определяет жизненный цикл записи от момента создания до завершения или отмены. Каждый статус имеет свои правила перехода, влияние на финансовую статистику и логику освобождения временных слотов.

## Статусы и их описание

### 1. Создана (CREATED)

**Описание:** Запись создана, время оказания услуги еще не наступило.

**Характеристики:**
- Клиент должен прийти в назначенное время
- Слот занят и недоступен для других записей
- Создается запись об ожидаемом доходе
- Может быть отменена клиентом или мастером

**Переходы:**
- → **На подтверждение (AWAITING_CONFIRMATION)** - автоматически через 1 минуту после `start_time`
- → **Отменена (CANCELLED)** - при отмене клиентом или мастером

**Финансовое влияние:**
- Участвует в расчете ожидаемых доходов
- Формула: `SUM(payment_amount) WHERE status = 'CREATED'`

### 2. На подтверждение (AWAITING_CONFIRMATION)

**Описание:** Автоматически переходит из "Создана" через 1 минуту после начала услуги.

**Характеристики:**
- Мастер должен подтвердить или отменить запись
- Ожидаемый доход сохраняется
- Промежуточный статус для верификации оказания услуги

**Переходы:**
- → **Подтверждена (COMPLETED)** - при подтверждении мастером
- → **Отменена (CANCELLED)** - при отмене мастером

**Финансовое влияние:**
- Участвует в расчете ожидаемых доходов
- Формула: `SUM(payment_amount) WHERE status = 'AWAITING_CONFIRMATION'`

### 3. Подтверждена (COMPLETED)

**Описание:** Мастер подтвердил, что услуга оказана.

**Характеристики:**
- Можно установить только после статуса "На подтверждение"
- Создается `BookingConfirmation` и `Income`
- Доход переходит из ожидаемого в подтвержденный
- Финальный статус - изменение невозможно

**Переходы:**
- Нет переходов (финальный статус)

**Финансовое влияние:**
- Создается запись в таблице `Income`
- Доход переходит из ожидаемого в подтвержденный
- Участвует в расчете фактических доходов

### 4. Отменена (CANCELLED)

**Описание:** Запись отменена на любом этапе.

**Характеристики:**
- Может быть установлена на любом этапе
- Фиксируется инициатор отмены (`cancelled_by_user_id`)
- Фиксируется причина отмены (`cancellation_reason`)
- Запись удаляется из доходов (ожидаемых или подтвержденных)
- Финальный статус - изменение невозможно

**Переходы:**
- Нет переходов (финальный статус)

**Финансовое влияние:**
- Удаляется из ожидаемых доходов
- Если была подтверждена - удаляется запись `Income`

## Причины отмены

При отмене записи фиксируется причина отмены в поле `cancellation_reason`:

| Код | Описание |
|-----|----------|
| `client_requested` | Клиент попросил отменить |
| `client_no_show` | Клиент не пришел на запись |
| `mutual_agreement` | Обоюдное согласие |
| `master_unavailable` | Мастер не может оказать услугу |

## Логика освобождения временных слотов

При отмене записи применяется следующая логика освобождения слотов:

### Отмена ДО начала услуги (статус CREATED)
- **Освобождаются:** ВСЕ слоты записи полностью
- **Пример:** Запись 14:00-15:00 отменена в 13:30 → освобождаются слоты 14:00, 14:10, 14:20, 14:30, 14:40, 14:50

### Отмена ПОСЛЕ начала услуги (статус AWAITING_CONFIRMATION)
- **Освобождаются:** Только следующие кратные 10 минутам слоты после текущего времени
- **Пример:** Запись 14:00-15:00, текущее время 14:25, отмена → освобождаются слоты 14:30, 14:40, 14:50

## Финансовая статистика

### Ожидаемые доходы
Вычисляются динамически из таблицы `bookings`:
```sql
SELECT SUM(payment_amount) 
FROM bookings 
WHERE status IN ('CREATED', 'AWAITING_CONFIRMATION')
```

### Подтвержденные доходы
Вычисляются из таблицы `Income`:
```sql
SELECT SUM(total_amount) 
FROM incomes 
WHERE booking_id IN (
    SELECT id FROM bookings WHERE status = 'COMPLETED'
)
```

## Автоматические переходы

### Переход CREATED → AWAITING_CONFIRMATION
- **Условие:** Прошло более 1 минуты после `start_time`
- **Реализация:** Функция `get_effective_booking_status()` в `backend/utils/booking_status.py`
- **Применение:** Во всех эндпоинтах, возвращающих записи

## API Эндпоинты

### Подтверждение записи
```
POST /api/master/accounting/confirm-booking/{booking_id}
```
- **Требования:** Статус должен быть `AWAITING_CONFIRMATION`
- **Результат:** Статус → `COMPLETED`, создание `BookingConfirmation` и `Income`

### Отмена записи
```
POST /api/master/accounting/cancel-booking/{booking_id}?cancellation_reason={reason}
```
- **Требования:** Статус должен быть `CREATED` или `AWAITING_CONFIRMATION`
- **Результат:** Статус → `CANCELLED`, установка `cancelled_by_user_id` и `cancellation_reason`

### Изменение статуса (для административных целей)
```
POST /api/master/accounting/update-booking-status/{booking_id}?new_status={status}
```
- **Доступные статусы:** `created`, `awaiting_confirmation`, `completed`, `cancelled`
- **Использование:** Только для исправления ошибок мастера

## Frontend отображение

### Цветовая схема статусов
- **Создана:** Синий (`bg-blue-500`)
- **На подтверждение:** Оранжевый (`bg-orange-500`)
- **Подтверждена:** Зеленый (`bg-green-500`)
- **Отменена:** Красный (`bg-red-500`)

### Текстовые названия
- **created:** "Создана"
- **awaiting_confirmation:** "На подтверждение"
- **completed:** "Подтверждена"
- **cancelled:** "Отменена"

## Миграция данных

При переходе на новую систему статусов:

1. **PENDING** → **CREATED**
2. **CONFIRMED** → **COMPLETED**
3. **CANCELLED** остается без изменений

Миграция выполняется через Alembic:
```sql
UPDATE bookings SET status = 'created' WHERE status = 'pending';
UPDATE bookings SET status = 'completed' WHERE status = 'confirmed';
```

## Тестирование

### Сценарии тестирования

1. **Создание записи**
   - Статус должен быть `CREATED`
   - Запись должна участвовать в ожидаемых доходах

2. **Автоматический переход**
   - Через 1 минуту после `start_time` статус должен стать `AWAITING_CONFIRMATION`

3. **Подтверждение записи**
   - Только записи со статусом `AWAITING_CONFIRMATION` могут быть подтверждены
   - После подтверждения создается `Income`

4. **Отмена записи**
   - Должна фиксироваться причина отмены
   - Должна применяться правильная логика освобождения слотов

5. **Финансовая статистика**
   - Ожидаемые доходы должны корректно рассчитываться
   - Подтвержденные доходы должны отображаться в `Income`

## Устранение неполадок

### Частые проблемы

1. **Записи не переходят в AWAITING_CONFIRMATION**
   - Проверить применение `get_effective_booking_status()` в эндпоинтах
   - Убедиться, что время `start_time` корректно

2. **Неправильный расчет ожидаемых доходов**
   - Проверить фильтры в эндпоинте `/api/master/accounting/summary`
   - Убедиться, что используются новые статусы

3. **Ошибки при подтверждении записи**
   - Проверить, что статус записи `AWAITING_CONFIRMATION`
   - Убедиться, что запись принадлежит мастеру

4. **Проблемы с отменой записи**
   - Проверить передачу `cancellation_reason`
   - Убедиться в корректности логики освобождения слотов
