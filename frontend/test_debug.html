<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏ API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>–û—Ç–ª–∞–¥–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏ API</h1>
    
    <div class="section">
        <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage</h2>
        <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
        <div id="localStorageInfo"></div>
    </div>
    
    <div class="section">
        <h2>2. –¢–µ—Å—Ç API –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</h2>
        <button onclick="testClientAPI()">–¢–µ—Å—Ç API /client/bookings/</button>
        <div id="clientAPIResult"></div>
    </div>
    
    <div class="section">
        <h2>3. –¢–µ—Å—Ç API –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <button onclick="testUserAPI()">–¢–µ—Å—Ç API /auth/users/me</button>
        <div id="userAPIResult"></div>
    </div>
    
    <div class="section">
        <h2>4. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <button onclick="createNewBooking()">–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <div id="bookingResult"></div>
    </div>
    
    <div class="section">
        <h2>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è</h2>
        <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" value="test123">
        <button onclick="verifyPassword()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        <div id="passwordResult"></div>
    </div>
    
    <script>
        function checkLocalStorage() {
            const div = document.getElementById('localStorageInfo');
            const token = localStorage.getItem('access_token');
            const newClientSetup = localStorage.getItem('new_client_setup');
            const existingClientVerification = localStorage.getItem('existing_client_verification');
            
            let html = '<h3>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ localStorage:</h3>';
            html += `<p><strong>access_token:</strong> ${token ? token.substring(0, 20) + '...' : '–ù–ï–¢'}</p>`;
            html += `<p><strong>new_client_setup:</strong> ${newClientSetup || '–ù–ï–¢'}</p>`;
            html += `<p><strong>existing_client_verification:</strong> ${existingClientVerification || '–ù–ï–¢'}</p>`;
            
            if (token) {
                html += '<p class="success">‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω</p>';
            } else {
                html += '<p class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
            }
            
            div.innerHTML = html;
        }
        
        async function testClientAPI() {
            const div = document.getElementById('clientAPIResult');
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                div.innerHTML = '<p class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage</p>';
                return;
            }
            
            try {
                const response = await fetch('/client/bookings/', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                div.innerHTML = `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}</p>`;
                
                if (response.ok) {
                    const data = await response.json();
                    div.innerHTML += `<p class="success">‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç</p>`;
                    div.innerHTML += `<p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:</strong> ${data.length}</p>`;
                    div.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    const errorData = await response.json();
                    div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞ API: ${JSON.stringify(errorData)}</p>`;
                }
            } catch (error) {
                div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</p>`;
            }
        }
        
        async function testUserAPI() {
            const div = document.getElementById('userAPIResult');
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                div.innerHTML = '<p class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage</p>';
                return;
            }
            
            try {
                const response = await fetch('/auth/users/me', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                div.innerHTML = `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}</p>`;
                
                if (response.ok) {
                    const data = await response.json();
                    div.innerHTML += `<p class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω</p>`;
                    div.innerHTML += `<p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.phone}</p>`;
                    div.innerHTML += `<p><strong>Email:</strong> ${data.email}</p>`;
                    div.innerHTML += `<p><strong>–†–æ–ª—å:</strong> ${data.role}</p>`;
                } else {
                    const errorData = await response.json();
                    div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞ API: ${JSON.stringify(errorData)}</p>`;
                }
            } catch (error) {
                div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</p>`;
            }
        }
        
        async function createNewBooking() {
            const div = document.getElementById('bookingResult');
            
            try {
                const bookingData = {
                    service_id: 1,
                    master_id: 3,
                    salon_id: null,
                    start_time: "2025-07-21T13:00:00",
                    end_time: "2025-07-21T15:00:00",
                    notes: "–¢–µ—Å—Ç–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
                };
                
                const params = new URLSearchParams({ client_phone: '+76666666666' });
                
                const response = await fetch(`/bookings/public?${params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });
                
                div.innerHTML = `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}</p>`;
                
                if (response.ok) {
                    const result = await response.json();
                    div.innerHTML += `<p class="success">‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ</p>`;
                    div.innerHTML += `<p><strong>ID:</strong> ${result.booking.id}</p>`;
                    div.innerHTML += `<p><strong>–¢–æ–∫–µ–Ω:</strong> ${result.access_token.substring(0, 20)}...</p>`;
                    div.innerHTML += `<p><strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è:</strong> ${result.needs_password_verification}</p>`;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                    localStorage.setItem('access_token', result.access_token);
                    if (result.needs_password_verification) {
                        localStorage.setItem('existing_client_verification', 'true');
                    }
                    
                    div.innerHTML += `<p class="info">üíæ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage</p>`;
                } else {
                    const errorData = await response.json();
                    div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(errorData)}</p>`;
                }
            } catch (error) {
                div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</p>`;
            }
        }
        
        async function verifyPassword() {
            const div = document.getElementById('passwordResult');
            const password = document.getElementById('passwordInput').value;
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                div.innerHTML = '<p class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage</p>';
                return;
            }
            
            try {
                const response = await fetch('/auth/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        password: password
                    })
                });
                
                div.innerHTML = `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}</p>`;
                
                if (response.ok) {
                    const result = await response.json();
                    div.innerHTML += `<p class="success">‚úÖ –ü–∞—Ä–æ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</p>`;
                    div.innerHTML += `<p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${result.message}</p>`;
                    
                    // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥
                    localStorage.removeItem('existing_client_verification');
                    div.innerHTML += `<p class="info">üíæ –§–ª–∞–≥ existing_client_verification —É–¥–∞–ª–µ–Ω</p>`;
                } else {
                    const errorData = await response.json();
                    div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(errorData)}</p>`;
                }
            } catch (error) {
                div.innerHTML += `<p class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</p>`;
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html> 