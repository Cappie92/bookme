# Система балансов и ежедневного списания

## Обзор

Система балансов позволяет пользователям пополнять счет и оплачивать подписки на сервис. Подписки списываются ежедневно с баланса пользователя.

## Основные компоненты

### 1. Модели данных

#### UserBalance
- `user_id` - связь с пользователем (один к одному)
- `balance` - текущий баланс в копейках
- `currency` - валюта (RUB)

#### BalanceTransaction
- `user_id` - пользователь
- `amount` - сумма операции в копейках
- `transaction_type` - тип операции (deposit, withdrawal, refund, upgrade)
- `description` - описание операции
- `subscription_id` - связь с подпиской (если применимо)
- `balance_before` - баланс до операции
- `balance_after` - баланс после операции

#### DailySubscriptionCharge
- `subscription_id` - связь с подпиской
- `charge_date` - дата списания
- `amount` - сумма списания в копейках
- `daily_rate` - стоимость дня по тарифу
- `balance_before` - баланс до списания
- `balance_after` - баланс после списания
- `status` - статус списания (success, failed, pending)

#### Subscription (обновленная)
- `start_date` - дата начала действия
- `end_date` - дата окончания действия
- `daily_rate` - стоимость одного дня
- `is_active` - активна ли подписка

### 2. API эндпоинты

#### Баланс (`/balance`)
- `GET /balance` - получить текущий баланс
- `POST /balance/deposit` - пополнить баланс
- `GET /balance/transactions` - история операций
- `GET /balance/subscription-status` - статус подписки с обратным отсчетом
- `GET /balance/low-balance-warning` - предупреждение о низком балансе

#### Подписки (обновленные)
- `POST /subscriptions/upgrade` - обновить тариф с учетом баланса
- `GET /subscriptions/status` - детальный статус с обратным отсчетом

### 3. Утилиты

#### balance_utils.py
- `rubles_to_kopecks()` - конвертация рублей в копейки
- `kopecks_to_rubles()` - конвертация копеек в рубли
- `get_or_create_user_balance()` - получить или создать баланс пользователя
- `deposit_balance()` - пополнить баланс
- `withdraw_balance()` - списать средства
- `calculate_subscription_daily_rate()` - рассчитать дневную ставку
- `calculate_upgrade_cost()` - рассчитать стоимость обновления тарифа
- `process_daily_charge()` - обработать ежедневное списание
- `get_subscription_status()` - получить статус подписки

### 4. Фоновые процессы

#### daily_charges.py
- `process_all_daily_charges()` - обработать все ежедневные списания
- `get_charge_statistics()` - получить статистику списаний
- `retry_failed_charges()` - повторить неуспешные списания
- `run_daily_charges_task()` - фоновая задача для ежедневного списания

## Логика работы

### 1. Пополнение баланса
1. Пользователь вводит сумму пополнения
2. Создается транзакция типа `deposit`
3. Баланс пользователя увеличивается
4. Записывается история операции

### 2. Ежедневное списание
1. Ежедневно в 00:01 запускается фоновая задача
2. Для каждой активной подписки:
   - Проверяется достаточность баланса
   - Если средств достаточно - списывается дневная ставка
   - Если средств недостаточно - подписка деактивируется
   - Создается запись о списании
   - Создается транзакция списания

### 3. Обновление тарифа
1. Рассчитывается стоимость нового тарифа на оставшиеся дни
2. Рассчитывается неиспользованный баланс текущего тарифа
3. Определяется доплата (округляется вверх)
4. Если доплата > 0, проверяется достаточность баланса
5. Списывается доплата с баланса
6. Создается новая подписка

### 4. Обратный отсчет
- Показывается количество оставшихся дней
- Показывается дневная ставка
- Показывается возможность продолжения подписки
- Показывается следующая дата списания

## Примеры использования

### Тестирование системы
```bash
cd backend
python test_daily_charges.py
```

### Ручной запуск ежедневных списаний
```python
from services.daily_charges import process_all_daily_charges
result = process_all_daily_charges()
print(result)
```

### Пополнение баланса через API
```bash
curl -X POST "http://localhost:8000/balance/deposit" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"amount": 1000.0, "payment_method": "card"}'
```

### Получение статуса подписки
```bash
curl -X GET "http://localhost:8000/balance/subscription-status" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Безопасность

1. **Точность расчетов** - все суммы хранятся в копейках
2. **Аудит операций** - каждая операция записывается с балансом до и после
3. **Проверка достаточности** - перед любой операцией проверяется баланс
4. **Защита от двойного списания** - проверка существующих списаний за дату

## Мониторинг

### Логирование
- Все операции логируются
- Ошибки записываются с деталями
- Статистика по списаниям

### Уведомления
- Предупреждения о низком балансе
- Уведомления о приостановке подписки
- Рекомендации по пополнению

## Интеграция с фронтендом

### Компоненты
- `DepositModal` - модальное окно пополнения баланса
- Обновленные дашборды с отображением баланса и статуса подписки
- Интеграция с существующими страницами тарифов

### API интеграция
- Автоматическая загрузка баланса и статуса подписки
- Обновление данных после операций
- Обработка ошибок и уведомлений

## Миграции

Система использует Alembic для управления миграциями:

```bash
# Создание новой миграции
python -m alembic revision --autogenerate -m "description"

# Применение миграций
python -m alembic upgrade head

# Откат миграции
python -m alembic downgrade -1
```

## Конфигурация

### Переменные окружения
- `DATABASE_URL` - URL базы данных
- `SECRET_KEY` - секретный ключ для JWT
- `ALEMBIC_CONFIG` - конфигурация Alembic

### Настройки по умолчанию
- Валюта: RUB
- Минимальная сумма пополнения: 1 рубль
- Округление доплаты: вверх до копеек
- Время ежедневного списания: 00:01

## Troubleshooting

### Частые проблемы

1. **Ошибка "Недостаточно средств"**
   - Проверить текущий баланс
   - Убедиться в достаточности средств для дневной ставки

2. **Подписка не списывается**
   - Проверить активность подписки
   - Проверить даты действия подписки
   - Проверить логи ежедневного списания

3. **Ошибки миграции**
   - Проверить совместимость с SQLite
   - Убедиться в отсутствии конфликтов с существующими таблицами

### Логи
```bash
# Просмотр логов приложения
tail -f logs/app.log

# Просмотр логов миграций
python -m alembic current
python -m alembic history
``` 