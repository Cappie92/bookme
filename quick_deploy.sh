#!/bin/bash

echo "üöÄ –ë–´–°–¢–†–´–ô –î–ï–ü–õ–û–ô –° –ù–£–õ–Ø"
echo "========================"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É..."
if ! ssh -o ConnectTimeout=10 root@193.160.208.206 "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'"; then
    error "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
fi

log "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

# –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
log "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh root@193.160.208.206 "cd /home/root && docker-compose -f dedato/docker-compose.prod.yml down"

# –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
log "–°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh root@193.160.208.206 "mkdir -p /home/root/dedato && rm -rf /home/root/dedato_old && mv /home/root/dedato /home/root/dedato_old 2>/dev/null || true && mkdir -p /home/root/dedato"

# –®–∞–≥ 3: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
log "–ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -r . root@193.160.208.206:/home/root/dedato/

# –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
log "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh root@193.160.208.206 "cd /home/root/dedato && docker-compose -f docker-compose.prod.yml up -d --build"

# –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
ssh root@193.160.208.206 "cd /home/root/dedato && docker-compose -f docker-compose.prod.yml ps"

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ API
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º API..."
sleep 10
if curl -s http://193.160.208.206:8000/health; then
    log "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    warn "‚ö†Ô∏è API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

# –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
if curl -s -I http://193.160.208.206:5173 | grep -q "200 OK"; then
    log "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    warn "‚ö†Ô∏è –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

echo ""
echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù!"
echo "=================="
echo "–°–∞–π—Ç: http://193.160.208.206:5173"
echo "API: http://193.160.208.206:8000"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
echo "1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã—Å—Ç—Ä–æ"
echo "2. –ï—Å—Ç—å –ª–∏ –ª–æ–≥–æ—Ç–∏–ø –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
echo "3. –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –ª–æ–≥–∏–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é SALON"
echo "4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞"
